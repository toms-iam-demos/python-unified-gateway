---
id: event-contract
title: Event contract
owner: you
status: draft
last_verified: 2025-12-21
tags: [pug, events, contract]
---

# Event contract (canonical normalized event)

## Intent
- Define the canonical, vendor-agnostic event representation.
- Make replay and audit possible without external systems.

## Contract
- **Inputs:** Raw inbox receipt (payload + headers) and verification outcome.
- **Outputs:** A normalized event folder under `data/events/.../<event_id>/`.
- **Invariants:** Immutable; deterministic normalization; schema versioned.
- **Failure modes:** Missing required fields; unparseable payload; unsupported provider.

## Folder layout (per event)

```text
data/events/YYYY/MM/DD/<event_id>/
  00_meta.json
  10_raw.json
  20_norm.json
  30_audit.json
  40_notes.md   (optional)
```

## 20_norm.json schema (v1)

```json
{
  "schema_version": "pug.event.v1",
  "event_id": "evt_...",
  "received_at": "2025-12-21T12:34:56.789Z",
  "provider": {
    "name": "docusign-iam",
    "event_type": "user.updated",
    "delivery_id": "optional-provider-delivery-id"
  },
  "subject": {
    "primary_id": "vendor-subject-id",
    "secondary_id": null
  },
  "trace": {
    "correlation_id": "corr_...",
    "request_id": "req_..."
  },
  "security": {
    "signature_present": true,
    "signature_valid": null,
    "auth_context": "webhook",
    "source_ip": "x.x.x.x"
  },
  "payload": {
    "canonical": {},
    "provider_raw_subset": {}
  }
}
```

### Field notes
- `event_id` is generated by PUG and must be stable across retries of the same receipt.
- `provider.delivery_id` should capture any provider retry identifier if available.
- `payload.canonical` is the normalized shape used by replay and demos.
- `payload.provider_raw_subset` is a sanitized, minimal subset for debugging (not secrets).

## 00_meta.json (recommended)
Tracks hashes, pointers to inbox receipts, and schema versions:

```json
{
  "event_id": "evt_...",
  "created_at": "2025-12-21T12:35:00Z",
  "source": {
    "inbox_path": "data/inbox/2025/12/21/....json",
    "headers_path": "data/inbox/2025/12/21/....headers.json",
    "sha256_payload": "..."
  },
  "schemas": {
    "event": "pug.event.v1",
    "provider_mapping": "docusign-iam.map.v1"
  }
}
```

## 30_audit.json (recommended)
```json
{
  "verified_at": "2025-12-21T12:35:01Z",
  "verification": {
    "method": "hmac-sha256",
    "result": "pass|fail|unknown",
    "details": "short reason"
  }
}
```

## Versioning rules
- Schema changes are additive whenever possible.
- Breaking changes require a new `pug.event.vN` and a migration/rebuild story.

## References
- Data flow: `../01_architecture/20_data-flow.md`
